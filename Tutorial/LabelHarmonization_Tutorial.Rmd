---
title: "Label Harmonization using ELeFHAnt Tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Label Harmonization using ELeFHAnt Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Introduction to ELeFHAnt: 
Ensemble Learning for Harmonization and Annotation of Single Cells (ELeFHAnt) provides an easy to use R package for users to annotate clusters of single cells, harmonize labels across single cell datasets to generate a unified atlas and infer relationship among celltypes between two datasets. It provides users with a flexibility of choosing a machine learning based classifiers or let ELeFHAnt automatically use the power of robust classifiers like randomForest and SVM (Support Vector Machines) to make predictions. It has three functions 1) CelltypeAnnotation 2) LabelHarmonization 3) DeduceRelationship.

LabelHarmonization Tutorial:

Step1:
Preparing reference1 and reference2 datasets (Please see: ELeFHAnt currently only accepts seurat objects. Please follow Seurat's Tutorial on how to generate a seurat object from raw counts / h5 etc.: https://satijalab.org/seurat/articles/pbmc3k_tutorial.html)

For example purpooses, let's download download reference1 and reference2 from ELeFHAnt plugin datasets using the following link: https://www.dropbox.com/sh/6hd2skriqqlokwp/AAAVol-_qPlCdA4DpERWjkeJa?dl=0

For this tutorial we will use reference1 as Gut_Atlas_duojejunum.rds and reference2 as FetalTissues_human_JasonSpenceLab.rds.

```{r prepareDatasets}
library(ELeFHAnt)

# read in reference1 and reference2
reference1 = readRDS('Gut_Atlas_duojejunum.rds')
reference2 = readRDS('FetalTissues_human_JasonSpenceLab.rds')

# let's look at the metadata of each reference1 and reference2 seurat object
head(reference1@meta.data)
head(reference2@meta.data)

# let's add Celltypes column to reference1, based on annotated celltypes column cell_name_detailed
reference1$Celltypes <- reference1$cell_name_detailed

# let's add Celltypes column to reference2, based on annotated celltypes column Cell_type
reference2$Celltypes <- reference2$Cell_type

# let's set the assay of each reference1 and reference2 to RNA
DefaultAssay(reference1) <- "RNA"
DefaultAssay(reference2) <- "RNA"

# Our reference1 and reference2 are now prepared for Label Harmonization
# Users can input as many reference seurat objects as they like. Please see: each object should have Celltypes column in meta.data
```

Step2:
Label Harmonization using ELeFHAnt. ELeFHAnt outputs a integrated seurat object with harmonized celltypes.
For this example we are downsampling each reference1 and reference2 to 50 cells per Celltypes respectively. Users can also provide an integrated object to bypass integration step. If downsampling on integrated object is set to TRUE, then ELeFHAnt returns an integrated object with same number of cells as in the input integrated object.
Downsampling is recommended for enabling fast computation. Please see Reproducuibility setcion on GitHub (https://github.com/praneet1988/ELeFHAnt) on deciding the value for downsample_to.
```{r LabelHarmonization}
# Running ELeFHAnt LabelHarmonization
out = LabelHarmonization(seurat.objects = c(reference1, reference2), perform_integration = TRUE, downsample = TRUE, downsample_to = 50, classification.method = "Ensemble", validatePredictions = FALSE, selectanchorfeatures = 2000, npcs = 30, resolution = 1)

# Let's look at the meta.data of output
head(out@meta.data)

# let's say you already have an integated seurat object with 100k cells. To harmonize the pre-computed integrated object please see the steps below:

# check if integrated object has Celltypes column.
# length(unique(integrated.object$Celltypes))

# Perform Harmonization
# out = LabelHarmonization(integrated.atlas = integrated.object, perform_integration = FALSE, downsample = TRUE, downsample_to = 50, classification.method = "Ensemble", validatePredictions = FALSE)

# Let's look at the meta.data of output
# head(out@meta.data)
```

Step3:
Visualizing Harmonized Celltypes from each classification.method: randomForest, SVM and Ensemble
```{r CelltypeVisualization, fig.height = 15, fig.width = 15}
# Coloring the clusters in UMAP using Harmonized Celltypes
p1 = DimPlot(out, group.by = "HarmonizedLabels_UsingRF", label = T, reduction = "umap") + NoLegend()
p2 = DimPlot(out, group.by = "HarmonizedLabels_UsingSVM", label = T, reduction = "umap") + NoLegend()
p3 = DimPlot(out, group.by = "HarmonizedLabels_UsingEnsemble", label = T, reduction = "umap") + NoLegend()

p1

p2

p3
```

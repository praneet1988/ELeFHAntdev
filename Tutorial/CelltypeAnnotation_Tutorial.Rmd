---
title: "Celltype Annotation using ELeFHAnt Tutorial"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Celltype Annotation using ELeFHAnt Tutorial}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Introduction to ELeFHAnt: 
Ensemble Learning for Harmonization and Annotation of Single Cells (ELeFHAnt) provides an easy to use R package for users to annotate clusters of single cells, harmonize labels across single cell datasets to generate a unified atlas and infer relationship among celltypes between two datasets. It provides users with a flexibility of choosing a machine learning based classifiers or let ELeFHAnt automatically use the power of robust classifiers like randomForest and SVM (Support Vector Machines) to make predictions. It has three functions 1) CelltypeAnnotation 2) LabelHarmonization 3) DeduceRelationship.

CelltypeAnnotation Tutorial:

Step1:
Preparing reference and query datasets (Please see: ELeFHAnt currently only accepts seurat objects. Please follow Seurat's Tutorial on how to generate a seurat object from raw counts / h5 etc.: https://satijalab.org/seurat/articles/pbmc3k_tutorial.html)

For example purpooses, let's download download reference and query from ELeFHAnt plugin datasets using the following link: https://www.dropbox.com/sh/6hd2skriqqlokwp/AAAVol-_qPlCdA4DpERWjkeJa?dl=0

For this tutorial we will use reference as Gut_Atlas_duojejunum.rds and query as FetalTissues_human_JasonSpenceLab.rds.

```{r prepareDatasets}
library(ELeFHAnt)

# read in reference and query
reference = readRDS('Gut_Atlas_duojejunum.rds')
query = readRDS('FetalTissues_human_JasonSpenceLab.rds')

# let's look at the metadata of each reference and query seurat object
head(reference@meta.data)
head(query@meta.data)

# let's add Celltypes column to reference, based on annotated celltypes column cell_name_detailed
reference$Celltypes <- reference$cell_name_detailed

# let's subset query to include only Intestinal cells
# Check the tissues present in the query 
unique(query$Corrected_organ_group)
Idents(query) <- query$Corrected_organ_group
query <- subset(query, idents = "Intestine")
query

# let's check if the query has seurat_clusters column in metadata
length(unique(query$seurat_clusters))

# let's set the assay of each reference and query to RNA
DefaultAssay(reference) <- "RNA"
DefaultAssay(query) <- "RNA"

# Our reference and query are now prepared for Celltype annotation
```

Step2:
Celltype Annotaton using ELeFHAnt. ELeFHAnt outputs a seurat object with predicted celltypes.
For this example we are downsampling each reference and query to 50 cells per Celltypes and seurat_clusters respectively. Downsampling is recommended for enabling fast computation. Please see Reproducuibility setcion on GitHub (https://github.com/praneet1988/ELeFHAnt) on deciding the value for downsample_to.
```{r CelltypeAnnotation}
# Running ELeFHAnt CelltypeAnnotation
out = CelltypeAnnotation(reference = reference, query = query, downsample = TRUE, downsample_to = 50, classification.method = "Ensemble", validatePredictions = FALSE, selectvarfeatures = 2000)

# Let's look at the meta.data of output
head(out@meta.data)
```

Step3:
Visualizing Predicted Celltypes from each classification.method: randomForest, SVM and Ensemble
```{r CelltypeVisualization, fig.height = 15, fig.width = 15}
# Coloring the clusters in UMAP using Predicted Celltypes
p1 = DimPlot(out, group.by = "PredictedCelltype_UsingRF", label = T, reduction = "umap") + NoLegend()
p2 = DimPlot(out, group.by = "PredictedCelltype_UsingSVM", label = T, reduction = "umap") + NoLegend()
p3 = DimPlot(out, group.by = "PredictedCelltype_UsingEnsemble", label = T, reduction = "umap") + NoLegend()

p1

p2

p3
```
